<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starbucks Geomarketing Board Game</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --board-bg: #eaddcf;
            --ring-1: #c8b7a6;
            --ring-2: #a09383;
            --ring-3: #756a5b;
            --sb-green: #00704A;
            --t1: #e74c3c; /* Rojo */
            --t2: #3498db; /* Azul */
            --t3: #f1c40f; /* Amarillo */
            --t4: #9b59b6; /* Morado */
        }

        body {
            font-family: 'Helvetica Neue', sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR (Panel Lateral) --- */
        #sidebar {
            width: 300px;
            background: #2c3e50;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        h1 { font-size: 1.5rem; margin-bottom: 20px; color: var(--sb-green); text-transform: uppercase; letter-spacing: 2px; }
        
        .score-box {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .team-indicator { width: 15px; height: 15px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .t1 { background: var(--t1); } .t2 { background: var(--t2); }
        .t3 { background: var(--t3); } .t4 { background: var(--t4); }

        #game-log {
            margin-top: auto;
            height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            font-size: 0.85rem;
            border-radius: 5px;
        }

        /* --- MAIN AREA (Tablero) --- */
        #main-area {
            flex-grow: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, #333 10%, #111 90%);
        }

        /* TABLERO CIRCULAR */
        #board-container {
            position: relative;
            width: 700px;
            height: 700px;
        }

        /* Anillos */
        .ring {
            position: absolute;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px dashed rgba(255,255,255,0.2);
            transition: all 0.5s;
        }

        /* Dimensiones de los anillos */
        #ring-outer { width: 650px; height: 650px; background-color: rgba(255, 255, 255, 0.05); z-index: 1; }
        #ring-middle { width: 450px; height: 450px; background-color: rgba(255, 255, 255, 0.1); z-index: 2; }
        #ring-inner { width: 250px; height: 250px; background-color: rgba(255, 255, 255, 0.15); z-index: 3; }
        
        /* Etiquetas de Anillo */
        .ring-label {
            position: absolute;
            top: 20px;
            font-weight: bold;
            text-transform: uppercase;
            color: rgba(255,255,255,0.4);
            font-size: 0.8rem;
        }

        /* SLOTS (Las casillas donde se juega) */
        .slot {
            position: absolute;
            width: 100px;
            height: 60px;
            background: white;
            color: #333;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s, background 0.3s;
            padding: 5px;
            border: 2px solid transparent;
            z-index: 10;
        }
        
        .slot:hover { transform: scale(1.1); z-index: 20; }
        .slot.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(100%); }
        .slot.occupied { color: white; border: 2px solid white; transform: scale(1); cursor: default; }

        /* Posicionamiento de Slots (Top, Right, Bottom, Left) */
        .pos-top { top: 0; left: 50%; transform: translate(-50%, -20%); }
        .pos-right { top: 50%; right: 0; transform: translate(20%, -50%); }
        .pos-bottom { bottom: 0; left: 50%; transform: translate(-50%, 20%); }
        .pos-left { top: 50%; left: 0; transform: translate(-20%, -50%); }

        /* Ajuste para anillo interior que es más pequeño */
        #ring-inner .pos-top { transform: translate(-50%, -50%); }
        #ring-inner .pos-right { transform: translate(50%, -50%); }
        #ring-inner .pos-bottom { transform: translate(-50%, 50%); }
        #ring-inner .pos-left { transform: translate(-50%, -50%); }


        /* Puntos revelados */
        .points-badge {
            display: none;
            background: #f1c40f;
            color: black;
            border-radius: 4px;
            padding: 2px 5px;
            margin-top: 3px;
            font-size: 0.9em;
        }

        /* --- MODAL (Preguntas y Avisos) --- */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            color: #333;
            width: 600px;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border-top: 10px solid var(--sb-green);
        }
        .hidden { display: none !important; }

        /* Botones del Modal */
        .opt-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #f4f4f4;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            text-align: left;
            transition: background 0.2s;
        }
        .opt-btn:hover { background: #e0e0e0; border-left: 5px solid var(--sb-green); }
        
        #action-btn {
            background: var(--sb-green);
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 1.2rem;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 20px;
        }
        #action-btn:hover { background: #00583a; }

        /* Status Banner */
        #status-bar {
            position: absolute;
            top: 20px;
            background: white;
            color: black;
            padding: 10px 30px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            font-size: 1.2rem;
            z-index: 50;
        }

    </style>
</head>
<body>

<div id="sidebar">
    <h1>Geo-Battle</h1>
    
    <div class="score-box" id="sb-0"><div style="display:flex;align-items:center"><span class="team-indicator t1"></span>Equipo 1</div><span id="sc-0">0</span></div>
    <div class="score-box" id="sb-1"><div style="display:flex;align-items:center"><span class="team-indicator t2"></span>Equipo 2</div><span id="sc-1">0</span></div>
    <div class="score-box" id="sb-2"><div style="display:flex;align-items:center"><span class="team-indicator t3"></span>Equipo 3</div><span id="sc-2">0</span></div>
    <div class="score-box" id="sb-3"><div style="display:flex;align-items:center"><span class="team-indicator t4"></span>Equipo 4</div><span id="sc-3">0</span></div>

    <div id="game-log">
        <p>> Juego Iniciado</p>
        <p>> Esperando lanzamiento...</p>
    </div>
</div>

<div id="main-area">
    <div id="status-bar">Fase de Preparación</div>

    <div id="board-container">
        <div class="ring" id="ring-outer">
            <span class="ring-label">Periferia</span>
            </div>

        <div class="ring" id="ring-middle">
            <span class="ring-label">Ciudad</span>
            </div>

        <div class="ring" id="ring-inner">
            <span class="ring-label">Prime</span>
            </div>
    </div>
</div>

<div id="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title">Bienvenidos</h2>
        <p id="modal-desc">Este es un juego de estrategia de localización. ¿Listos?</p>
        <div id="modal-options"></div>
        <button id="action-btn" onclick="startGame()">Empezar Partida</button>
    </div>
</div>

<script>
    // --- CONFIGURACIÓN DE DATOS ---
    const teams = [
        { name: "Equipo 1", color: "var(--t1)", score: 0 },
        { name: "Equipo 2", color: "var(--t2)", score: 0 },
        { name: "Equipo 3", color: "var(--t3)", score: 0 },
        { name: "Equipo 4", color: "var(--t4)", score: 0 }
    ];

    const locationsData = [
        {
            ringId: "ring-outer",
            places: [
                { name: "Centro Comercial", points: 500, pos: "pos-top" },
                { name: "Gasolinera", points: 200, pos: "pos-right" },
                { name: "Barrio Dormitorio", points: 100, pos: "pos-bottom" },
                { name: "Colegio Privado", points: 400, pos: "pos-left" }
            ]
        },
        {
            ringId: "ring-middle",
            places: [
                { name: "Junto a Competencia", points: 600, pos: "pos-top" },
                { name: "Calle Secundaria", points: 150, pos: "pos-right" },
                { name: "Metro / Bus", points: 500, pos: "pos-bottom" },
                { name: "Parque", points: 250, pos: "pos-left" }
            ]
        },
        {
            ringId: "ring-inner",
            places: [
                { name: "Aeropuerto", points: 1000, pos: "pos-top" },
                { name: "Callejón Centro", points: 50, pos: "pos-right" },
                { name: "Torre Oficinas", points: 800, pos: "pos-bottom" },
                { name: "Plaza Turística", points: 700, pos: "pos-left" }
            ]
        }
    ];

    const questions = [
        { q: "¿Qué mide una isócrona?", opts: ["Distancia en km", "Tiempo de viaje", "Densidad", "Ventas"], a: 1 },
        { q: "¿Qué es el efecto clustering?", opts: ["Dispersión", "Agrupamiento denso", "Venta online", "Franquicia"], a: 1 },
        { q: "¿Qué dato NO es demográfico?", opts: ["Edad", "Renta", "Flujo peatonal", "Sexo"], a: 2 },
        { q: "La canibalización es buena si...", opts: ["Se pierde dinero", "Sube el total zonal", "Cierra el local", "Baja el alquiler"], a: 1 },
        
        { q: "¿Qué es Población Flotante?", opts: ["Vive en la zona", "Pasa por la zona", "Trabaja online", "No gasta"], a: 1 },
        { q: "¿Locomotora comercial es...?", opts: ["Un tren", "Una tienda ancla", "Un camión", "Un parking"], a: 1 },
        { q: "¿Qué busca el análisis de acera?", opts: ["Sombra", "Flujo direccional", "Anchura", "Limpieza"], a: 1 },
        { q: "En oficinas, ¿qué importa más?", opts: ["Comodidad", "Rapidez", "Wifi", "Decoración"], a: 1 },

        { q: "¿Geofencing usa...?", opts: ["Vallas físicas", "GPS/Móvil", "Email", "Encuestas"], a: 1 },
        { q: "Share of Wallet es...", opts: ["Cuota de mercado", "Gasto por cliente", "Coste", "Beneficio"], a: 1 },
        { q: "¿Sistema usado por Starbucks?", opts: ["Atlas (GIS)", "Excel", "Google Earth", "Maps"], a: 0 },
        { q: "¿Objetivo del geomarketing?", opts: ["Hacer mapas", "Inteligencia territorial", "Diseño", "Vender casas"], a: 1 }
    ];

    // --- VARIABLES DE ESTADO ---
    let currentRound = 0; // 0, 1, 2
    let questionIdx = 0;
    let turnOrder = [];
    let selectionQueue = [];
    let currentPhase = 'idle'; 

    // --- FUNCIONES DE UI ---
    function log(msg) {
        let box = document.getElementById('game-log');
        box.innerHTML += `<p>> ${msg}</p>`;
        box.scrollTop = box.scrollHeight;
    }

    function updateScores() {
        teams.forEach((t, i) => {
            document.getElementById(`sc-${i}`).innerText = t.score;
        });
    }

    function setStatus(msg) {
        document.getElementById('status-bar').innerText = msg;
    }

    function renderBoard(round) {
        // Limpia slots antiguos y activa visualmente el anillo actual
        document.querySelectorAll('.ring').forEach(r => {
            r.innerHTML = `<span class="ring-label">${r.querySelector('.ring-label').innerText}</span>`; // Keep label, clear slots
            r.style.borderColor = "rgba(255,255,255,0.1)";
            r.style.opacity = "0.3";
        });

        // Highlight current ring
        let activeRingData = locationsData[round];
        let ringEl = document.getElementById(activeRingData.ringId);
        ringEl.style.borderColor = "var(--sb-green)";
        ringEl.style.opacity = "1";
        ringEl.style.boxShadow = "0 0 20px rgba(0,255,100,0.1)";

        // Create Slots
        activeRingData.places.forEach((place, idx) => {
            let slot = document.createElement('div');
            slot.className = `slot ${place.pos}`;
            slot.innerHTML = `<div>${place.name}</div><div class="points-badge">+${place.points}</div>`;
            slot.dataset.points = place.points;
            slot.dataset.idx = idx;
            slot.onclick = () => handleSlotClick(slot, idx);
            ringEl.appendChild(slot);
        });
    }

    // --- LÓGICA DEL JUEGO ---

    function startGame() {
        document.getElementById('modal-overlay').classList.add('hidden');
        currentRound = 0;
        // Orden aleatorio inicial
        turnOrder = [0, 1, 2, 3].sort(() => Math.random() - 0.5);
        log("Orden de turno aleatorio: " + turnOrder.map(i => teams[i].name).join(", "));
        startRound();
    }

    function startRound() {
        if(currentRound >= 3) { endGame(); return; }
        
        setStatus(`Ronda ${currentRound + 1}: ${locationsData[currentRound].ringId.replace('ring-', '').toUpperCase()}`);
        log(`--- INICIO RONDA ${currentRound + 1} ---`);
        
        renderBoard(currentRound);
        
        // Reset queues
        selectionQueue = []; 
        questionIdx = 0; // Dentro de la ronda
        
        // Start Question Phase
        playQuestionTurn();
    }

    function playQuestionTurn() {
        if(questionIdx >= 4) {
            // Fin de preguntas, vamos a selección
            startSelectionPhase();
            return;
        }

        let teamIdx = turnOrder[questionIdx];
        let qIndexGlobal = (currentRound * 4) + questionIdx;
        let q = questions[qIndexGlobal];

        showModalQuestion(teams[teamIdx].name, q, (isCorrect) => {
            if(isCorrect) {
                log(`${teams[teamIdx].name} acertó.`);
                selectionQueue.unshift(teamIdx); // Pone al principio
            } else {
                log(`${teams[teamIdx].name} falló.`);
                selectionQueue.push(teamIdx); // Pone al final
            }
            questionIdx++;
            playQuestionTurn();
        });
    }

    function showModalQuestion(teamName, qData, cb) {
        let m = document.getElementById('modal-overlay');
        let title = document.getElementById('modal-title');
        let desc = document.getElementById('modal-desc');
        let opts = document.getElementById('modal-options');
        let btn = document.getElementById('action-btn');

        m.classList.remove('hidden');
        title.innerText = `Turno: ${teamName}`;
        title.style.color = teams[turnOrder[questionIdx]].color; // Team color
        desc.innerText = qData.q;
        btn.style.display = 'none';
        
        opts.innerHTML = '';
        qData.opts.forEach((opt, idx) => {
            let b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = opt;
            b.onclick = () => {
                m.classList.add('hidden');
                cb(idx === qData.a);
            };
            opts.appendChild(b);
        });
    }

    // --- FASE DE SELECCIÓN EN EL TABLERO ---
    
    let pickingIdx = 0;

    function startSelectionPhase() {
        pickingIdx = 0;
        log("Fase de Selección: El tablero está activo.");
        nextPick();
    }

    function nextPick() {
        if(pickingIdx >= 4) {
            endRound();
            return;
        }
        
        let teamIdx = selectionQueue[pickingIdx];
        let team = teams[teamIdx];
        
        setStatus(`Turno de Selección: ${team.name}`);
        
        // Modal pequeño informativo
        let m = document.getElementById('modal-overlay');
        let title = document.getElementById('modal-title');
        let desc = document.getElementById('modal-desc');
        let opts = document.getElementById('modal-options');
        let btn = document.getElementById('action-btn');

        m.classList.remove('hidden');
        title.innerText = `¡A elegir sitio!`;
        title.style.color = team.color;
        desc.innerText = `${team.name}, haz clic en una ubicación disponible en el anillo iluminado.`;
        opts.innerHTML = '';
        btn.style.display = 'block';
        btn.innerText = "Ir al Mapa";
        btn.onclick = () => {
            m.classList.add('hidden');
            enableBoardInteraction(teamIdx);
        }
    }

    function enableBoardInteraction(teamIdx) {
        // Marcamos el estado global
        currentPhase = 'picking';
        document.body.dataset.activeTeam = teamIdx; // Para saber quién clica
    }

    function handleSlotClick(slotElement, locIdx) {
        if(currentPhase !== 'picking') return;
        if(slotElement.classList.contains('occupied')) return;

        let teamIdx = parseInt(document.body.dataset.activeTeam);
        let team = teams[teamIdx];
        let points = parseInt(slotElement.dataset.points);

        // Visual update
        slotElement.classList.add('occupied');
        slotElement.style.background = team.color;
        slotElement.style.borderColor = "white";
        
        // Logic Update
        team.score += points;
        updateScores();
        log(`${team.name} ocupó ${slotElement.innerText.split('\n')[0]}`);

        // Next
        currentPhase = 'idle';
        pickingIdx++;
        nextPick();
    }

    function endRound() {
        // Revelar puntos
        document.querySelectorAll('.points-badge').forEach(el => el.style.display = 'block');
        
        setTimeout(() => {
            alert("Fin de Ronda. ¡Mira los puntos conseguidos!");
            // Rotar orden para la siguiente
            turnOrder.push(turnOrder.shift());
            currentRound++;
            startRound();
        }, 2000);
    }

    function endGame() {
        let max = Math.max(...teams.map(t => t.score));
        let winners = teams.filter(t => t.score === max);
        
        let m = document.getElementById('modal-overlay');
        m.classList.remove('hidden');
        document.getElementById('modal-options').innerHTML = '';
        document.getElementById('action-btn').innerText = "Reiniciar";
        document.getElementById('action-btn').onclick = () => location.reload();
        
        let title = document.getElementById('modal-title');
        title.innerText = "¡FIN DEL JUEGO!";
        title.style.color = "gold";
        
        document.getElementById('modal-desc').innerHTML = `
            <h1>Ganador: ${winners.map(w => w.name).join(' y ')}</h1>
            <p>Puntuación Final: ${max} puntos</p>
        `;
    }

</script>
</body>
</html>
