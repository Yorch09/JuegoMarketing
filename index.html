<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starbucks Geomarketing: Batalla Final</title>
    <style>
        :root {
            --bg-color: #1e1e1e;
            --sb-green: #00704A;
            --t1: #e74c3c; /* Rojo */
            --t2: #3498db; /* Azul */
            --t3: #f1c40f; /* Amarillo */
            --t4: #9b59b6; /* Morado */
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 250px;
            background: #2c3e50;
            padding: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 4px 0 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        h1 { font-size: 1.2rem; color: var(--sb-green); text-transform: uppercase; letter-spacing: 1px; text-align: center;}
        
        .score-box {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        .team-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .t1 { background: var(--t1); } .t2 { background: var(--t2); }
        .t3 { background: var(--t3); } .t4 { background: var(--t4); }

        #game-log {
            margin-top: auto;
            height: 150px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            font-size: 0.8rem;
            border-radius: 5px;
            font-family: monospace;
        }

        /* --- MAIN AREA --- */
        #main-area {
            flex-grow: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle, #333 10%, #111 90%);
        }

        /* TABLERO RESPONSIVE (Usa vh para no salirse) */
        #board-container {
            position: relative;
            /* El tablero será un cuadrado basado en la altura de la pantalla */
            width: 85vh; 
            height: 85vh;
            max-width: 800px;
            max-height: 800px;
        }

        .ring {
            position: absolute;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px dashed rgba(255,255,255,0.15);
            transition: all 0.5s;
        }

        /* Tamaños relativos al contenedor padre */
        #ring-outer { width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.02); z-index: 1; }
        #ring-middle { width: 70%; height: 70%; background-color: rgba(255, 255, 255, 0.05); z-index: 2; }
        #ring-inner { width: 40%; height: 40%; background-color: rgba(255, 255, 255, 0.08); z-index: 3; }
        
        .ring-label {
            position: absolute;
            top: 10%;
            font-weight: bold;
            text-transform: uppercase;
            color: rgba(255,255,255,0.3);
            font-size: 0.8rem;
            pointer-events: none;
        }

        /* SLOTS */
        .slot {
            position: absolute;
            width: 18%; /* Relativo al tablero */
            height: 10%;
            background: #f0f0f0;
            color: #333;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 0.7rem;
            font-weight: bold;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            padding: 2px;
            z-index: 10;
        }
        
        .slot:hover { transform: scale(1.1); z-index: 20; background: white;}
        .slot.occupied { color: white; border: 2px solid white; transform: scale(1); cursor: default; }

        /* Posiciones */
        .pos-top { top: 0; left: 50%; transform: translate(-50%, 20%); }
        .pos-right { top: 50%; right: 0; transform: translate(-20%, -50%); }
        .pos-bottom { bottom: 0; left: 50%; transform: translate(-50%, -20%); }
        .pos-left { top: 50%; left: 0; transform: translate(20%, -50%); }

        /* Ajustes visuales específicos para que no se solapen */
        #ring-inner .pos-top { transform: translate(-50%, -20%); } 

        .points-badge {
            display: none;
            background: #f1c40f;
            color: black;
            border-radius: 3px;
            padding: 1px 4px;
            margin-top: 2px;
            font-size: 0.8em;
        }

        /* --- MODAL --- */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: white;
            color: #333;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            border-top: 8px solid var(--sb-green);
        }
        .hidden { display: none !important; }

        .opt-btn {
            display: block; width: 100%; padding: 12px; margin: 8px 0;
            background: #eee; border: none; border-radius: 4px;
            cursor: pointer; text-align: left; font-size: 1rem;
            transition: background 0.2s;
        }
        .opt-btn:hover { background: #ddd; border-left: 5px solid var(--sb-green); }
        
        #action-btn {
            background: var(--sb-green); color: white; border: none;
            padding: 10px 25px; font-size: 1.1rem; border-radius: 20px;
            cursor: pointer; margin-top: 15px;
        }

        #status-bar {
            position: absolute; top: 15px; background: white; color: black;
            padding: 8px 20px; border-radius: 20px; font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 50;
        }

        /* Tabla de resultados */
        .results-table {
            width: 100%; text-align: left; margin-top: 15px; border-collapse: collapse;
        }
        .results-table th { border-bottom: 2px solid #ccc; padding: 5px; }
        .results-table td { border-bottom: 1px solid #eee; padding: 8px 5px; font-size: 0.9rem; }
        .reason-text { font-style: italic; color: #666; font-size: 0.85rem; display: block; margin-top: 2px;}

    </style>
</head>
<body>

<div id="sidebar">
    <h1>Geo-Battle</h1>
    <div class="score-box" id="sb-0"><div style="display:flex;align-items:center"><span class="team-indicator t1"></span>Equipo 1</div><span id="sc-0">0</span></div>
    <div class="score-box" id="sb-1"><div style="display:flex;align-items:center"><span class="team-indicator t2"></span>Equipo 2</div><span id="sc-1">0</span></div>
    <div class="score-box" id="sb-2"><div style="display:flex;align-items:center"><span class="team-indicator t3"></span>Equipo 3</div><span id="sc-2">0</span></div>
    <div class="score-box" id="sb-3"><div style="display:flex;align-items:center"><span class="team-indicator t4"></span>Equipo 4</div><span id="sc-3">0</span></div>
    <div id="game-log"></div>
</div>

<div id="main-area">
    <div id="status-bar">Preparando la Batalla...</div>

    <div id="board-container">
        <div class="ring" id="ring-outer">
            <span class="ring-label">Periferia</span>
        </div>
        <div class="ring" id="ring-middle">
            <span class="ring-label">Ciudad</span>
        </div>
        <div class="ring" id="ring-inner">
            <span class="ring-label">Prime</span>
        </div>
    </div>
</div>

<div id="modal-overlay">
    <div class="modal-content">
        <h2 id="modal-title">Starbucks Geo-Challenge</h2>
        <div id="modal-body">
            <p>Bienvenido a la simulación de expansión comercial.</p>
            <p>Competiréis por las mejores ubicaciones.</p>
        </div>
        <div id="modal-options"></div>
        <button id="action-btn" onclick="startGame()">Comenzar</button>
    </div>
</div>

<script>
    // --- DATOS EDUCATIVOS COMPLETOS ---
    const teams = [
        { name: "Equipo 1", color: "#e74c3c", score: 0 },
        { name: "Equipo 2", color: "#3498db", score: 0 },
        { name: "Equipo 3", color: "#f1c40f", score: 0 },
        { name: "Equipo 4", color: "#9b59b6", score: 0 }
    ];

    const locationsData = [
        {
            ringId: "ring-outer",
            name: "PERIFERIA",
            places: [
                { name: "C. Comercial", points: 500, pos: "pos-top", reason: "Generador de tráfico de ocio y compras (Mix comercial)." },
                { name: "Gasolinera", points: 200, pos: "pos-right", reason: "Tráfico rápido, ticket bajo y sin estancia." },
                { name: "Barrio Dormitorio", points: 50, pos: "pos-bottom", reason: "Vacío en horario laboral. Solo funciona fines de semana." },
                { name: "Salida Colegio", points: 400, pos: "pos-left", reason: "Pico muy alto de demanda a las 16:00 (padres)." }
            ]
        },
        {
            ringId: "ring-middle",
            name: "CIUDAD",
            places: [
                { name: "Junto a Rival", points: 600, pos: "pos-top", reason: "CLUSTERING: Capturas su cola y generas 'zona cafetera'." },
                { name: "Calle Secundaria", points: 150, pos: "pos-right", reason: "Poco flujo natural. Requiere mucha inversión en publi." },
                { name: "Boca de Metro", points: 500, pos: "pos-bottom", reason: "Volumen masivo de Take-Away por la mañana." },
                { name: "Parque", points: 250, pos: "pos-left", reason: "Estancia agradable, pero baja rotación de mesas." }
            ]
        },
        {
            ringId: "ring-inner",
            name: "ZONA PRIME",
            places: [
                { name: "Aeropuerto", points: 1000, pos: "pos-top", reason: "Cliente cautivo + Tiempos de espera + Precios altos." },
                { name: "Callejón", points: 0, pos: "pos-right", reason: "Sin visibilidad no hay venta por impulso en zona prime." },
                { name: "Torre Oficinas", points: 800, pos: "pos-bottom", reason: "Alta recurrencia diaria y ticket de reuniones." },
                { name: "Plaza Turística", points: 700, pos: "pos-left", reason: "Flujo constante, pero alquileres muy caros." }
            ]
        }
    ];

    const questions = [
        // R1
        { q: "¿Qué define mejor una Isócrona?", opts: ["Distancia en línea recta", "Área delimitada por tiempo de viaje", "Barrio administrativo", "Zona de reparto"], a: 1 },
        { q: "El 'Efecto Starbucks' de clustering busca...", opts: ["Cerrar tiendas", "Bajar precios", "Saturar para reducir colas y bloquear rivales","Vender solo online"], a: 2 },
        { q: "¿Qué dato usa el Big Data para movilidad?", opts: ["Encuestas en papel", "Censo de 2010", "Número de ventanas", "Señal GPS y móvil"], a: 3 },
        { q: "En retail, la 'canibalización' es...", opts: ["Aceptable si la venta total de zona sube""Mala siempre", "Ilegal", "Comer en la tienda"], a: 0 },
        // R2
        { q: "¿Qué es la Población Flotante?", opts: ["Gente que vive en la zona", "Población que varía de peso", "Turistas y trabajadores no residentes", "Clientes online"], a: 2 },
        { q: "¿Qué mide la 'Cuota de Bolsillo'?", opts: ["El tamaño de la cartera", "Gasto de un hogar en tu categoría", "Propinas", "Beneficio neto"], a: 1 },
        { q: "Una 'Locomotora Comercial' es...", opts: ["Un Zara o Apple que atrae gente", "Una estación de tren", "Un camión de reparto", "Una tienda que cierra pronto"], a: 0 },
        { q: "En zona de oficinas, la clave es...", opts: ["Sofás cómodos", "Rapidez y servicio express", "Zona infantil", "Música alta"], a: 1 },
        // R3
        { q: "El Geomarketing ayuda a...", opts: ["Predecir facturación antes de abrir", "Hacer mapas bonitos", "Decorar el local", "Contratar camareros"], a: 0 },
        { q: "¿Qué es Geofencing?", opts: ["Vallas de seguridad", "Diseño de interiores", "Robo de clientes", "Publicidad activada por ubicación GPS"], a: 3 },
        { q: "Para una marca de lujo importa...", opts: ["Mucha gente", "Alta renta y turismo", "Estar cerca de colegios", "Parking gratis"], a: 1 },
        { q: "¿Por qué Starbucks abre dos tiendas juntas?", opts: ["Por error", "Porque sobraba dinero", "Para reducir tiempos de espera", "Para competir entre gerentes"], a: 2 }
    ];

    // --- ESTADO ---
    let currentRound = 0;
    let questionIdx = 0;
    let turnOrder = [];
    let winnersQueue = []; // Cola de los que aciertan (PRIORIDAD)
    let losersQueue = [];  // Cola de los que fallan
    let finalSelectionQueue = []; 
    let pickedLog = []; // Registro de selecciones de la ronda actual

    // --- LÓGICA ---

    function log(msg) {
        let box = document.getElementById('game-log');
        box.innerHTML += `> ${msg}<br>`;
        box.scrollTop = box.scrollHeight;
    }

    function updateScores() {
        teams.forEach((t, i) => document.getElementById(`sc-${i}`).innerText = t.score);
    }

    function setStatus(msg) { document.getElementById('status-bar').innerText = msg; }

    function renderBoard(roundIdx) {
        // Reset visual
        document.querySelectorAll('.ring').forEach(r => {
            r.style.borderColor = "rgba(255,255,255,0.15)";
            r.style.opacity = "0.4";
            // Limpiar slots viejos pero mantener label
            let label = r.querySelector('.ring-label').innerText;
            r.innerHTML = `<span class="ring-label">${label}</span>`;
        });

        // Activar anillo actual
        let activeData = locationsData[roundIdx];
        let ringEl = document.getElementById(activeData.ringId);
        ringEl.style.borderColor = "var(--sb-green)";
        ringEl.style.opacity = "1";
        
        // Crear Slots
        activeData.places.forEach((p, idx) => {
            let slot = document.createElement('div');
            slot.className = `slot ${p.pos}`;
            slot.innerHTML = `<div>${p.name}</div><div class="points-badge">+${p.points}</div>`;
            slot.onclick = () => handleSlotClick(slot, idx);
            // Datos ocultos en el elemento
            slot.dataset.points = p.points;
            slot.dataset.reason = p.reason;
            slot.dataset.idx = idx;
            ringEl.appendChild(slot);
        });
    }

    function startGame() {
        document.getElementById('modal-overlay').classList.add('hidden');
        currentRound = 0;
        // Orden aleatorio de equipos
        turnOrder = [0, 1, 2, 3].sort(() => Math.random() - 0.5);
        log("Orden sorteado: " + turnOrder.map(i => teams[i].name).join(", "));
        startRound();
    }

    function startRound() {
        if(currentRound >= 3) { endGame(); return; }
        
        // Reset colas
        winnersQueue = [];
        losersQueue = [];
        pickedLog = [];
        questionIdx = 0;

        renderBoard(currentRound);
        let ringName = locationsData[currentRound].name;
        setStatus(`Ronda ${currentRound + 1}: ${ringName}`);
        log(`--- INICIO ${ringName} ---`);
        
        playQuestion();
    }

    function playQuestion() {
        if(questionIdx >= 4) {
            startSelectionPhase();
            return;
        }

        let teamIdx = turnOrder[questionIdx];
        let qData = questions[(currentRound * 4) + questionIdx];

        showModalQuestion(teams[teamIdx], qData, (correct) => {
            if(correct) {
                log(`${teams[teamIdx].name} acertó.`);
                winnersQueue.push(teamIdx); // Se añade al final de la lista de ganadores
            } else {
                log(`${teams[teamIdx].name} falló.`);
                losersQueue.push(teamIdx);
            }
            questionIdx++;
            playQuestion();
        });
    }

    function showModalQuestion(team, qData, cb) {
        let m = document.getElementById('modal-overlay');
        let title = document.getElementById('modal-title');
        let body = document.getElementById('modal-body');
        let opts = document.getElementById('modal-options');
        let btn = document.getElementById('action-btn');

        m.classList.remove('hidden');
        title.innerText = `Turno: ${team.name}`;
        title.style.color = team.color;
        body.innerHTML = `<p style="font-size:1.2rem; font-weight:bold">${qData.q}</p>`;
        
        opts.innerHTML = '';
        btn.style.display = 'none';

        qData.opts.forEach((txt, i) => {
            let b = document.createElement('button');
            b.className = 'opt-btn';
            b.innerText = txt;
            b.onclick = () => {
                m.classList.add('hidden');
                cb(i === qData.a);
            };
            opts.appendChild(b);
        });
    }

    // --- FASE SELECCIÓN ---
    let pickCounter = 0;

    function startSelectionPhase() {
        // Combinamos colas: PRIMERO los ganadores (en orden), LUEGO los perdedores
        finalSelectionQueue = [...winnersQueue, ...losersQueue];
        pickCounter = 0;
        
        log("Orden de elección: " + finalSelectionQueue.map(i => teams[i].name).join(", "));
        nextPick();
    }

    function nextPick() {
        if(pickCounter >= 4) {
            endRoundSummary();
            return;
        }

        let teamIdx = finalSelectionQueue[pickCounter];
        let team = teams[teamIdx];
        
        setStatus(`Eligiendo: ${team.name}`);
        
        // Modal aviso
        let m = document.getElementById('modal-overlay');
        m.classList.remove('hidden');
        document.getElementById('modal-title').innerText = "Momento de Decisión";
        document.getElementById('modal-title').style.color = team.color;
        document.getElementById('modal-body').innerHTML = `
            <p><strong>${team.name}</strong> tiene el turno.</p>
            <p>Elige una ubicación disponible en el anillo iluminado.</p>
        `;
        document.getElementById('modal-options').innerHTML = '';
        let btn = document.getElementById('action-btn');
        btn.style.display = 'inline-block';
        btn.innerText = "Ir al Mapa";
        btn.onclick = () => {
            m.classList.add('hidden');
            document.body.dataset.pickingTeam = teamIdx; // Flag
        };
    }

    function handleSlotClick(slot, idx) {
        let teamIdx = document.body.dataset.pickingTeam;
        if(teamIdx === undefined || teamIdx === "") return;
        if(slot.classList.contains('occupied')) return; // Ya cogido

        // Procesar click
        let team = teams[teamIdx];
        let pts = parseInt(slot.dataset.points);
        let reason = slot.dataset.reason;
        let name = slot.innerText.split('\n')[0];

        // Visual
        slot.classList.add('occupied');
        slot.style.backgroundColor = team.color;
        slot.style.borderColor = "white";
        slot.style.color = "white";

        // Logic
        team.score += pts;
        updateScores();
        log(`${team.name} eligió ${name}`);
        
        // Guardar para resumen
        pickedLog.push({ tName: team.name, tColor: team.color, loc: name, pts: pts, r: reason });

        // Limpiar flag y siguiente
        document.body.dataset.pickingTeam = "";
        pickCounter++;
        nextPick();
    }

    function endRoundSummary() {
        // Mostrar puntos en tablero
        document.querySelectorAll('.points-badge').forEach(b => b.style.display = 'block');

        // Construir tabla de resumen educativo
        let html = `<p>Resultados del Anillo ${locationsData[currentRound].name}</p>
                    <table class="results-table">
                        <tr><th>Equipo</th><th>Lugar</th><th>Puntos</th><th>¿Por qué?</th></tr>`;
        
        pickedLog.forEach(row => {
            html += `<tr>
                <td style="color:${row.tColor}; font-weight:bold">${row.tName}</td>
                <td>${row.loc}</td>
                <td><b>${row.pts}</b></td>
                <td><span class="reason-text">${row.r}</span></td>
            </tr>`;
        });
        html += `</table>`;

        // Mostrar Modal Resumen
        setTimeout(() => {
            let m = document.getElementById('modal-overlay');
            m.classList.remove('hidden');
            document.getElementById('modal-title').innerText = "Análisis de Resultados";
            document.getElementById('modal-title').style.color = "var(--sb-green)";
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('modal-options').innerHTML = '';
            
            let btn = document.getElementById('action-btn');
            btn.innerText = "Siguiente Ronda";
            btn.onclick = () => {
                // Rotar orden inicial para equidad en preguntas
                turnOrder.push(turnOrder.shift());
                currentRound++;
                startRound();
            };
        }, 1000);
    }

    function endGame() {
        let max = Math.max(...teams.map(t => t.score));
        let winners = teams.filter(t => t.score === max);
        
        let m = document.getElementById('modal-overlay');
        m.classList.remove('hidden');
        document.getElementById('modal-title').innerText = "¡FIN DE LA PARTIDA!";
        document.getElementById('modal-title').style.color = "gold";
        
        let wNames = winners.map(w => w.name).join(" y ");
        document.getElementById('modal-body').innerHTML = `
            <h1 style="font-size:2rem; color:${winners[0].color}">${wNames}</h1>
            <p>Dominio total del mercado con ${max} puntos.</p>
        `;
        document.getElementById('action-btn').innerText = "Reiniciar Juego";
        document.getElementById('action-btn').onclick = () => location.reload();
    }

</script>
</body>
</html>
